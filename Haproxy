Configure HAProxy
We will use haproxy to load balance the Openshift services like ectd, ingress http & ingress https and apps like openshift console.

Install haproxy

[root@dcpctredcont1 ~]#  dnf install -y haproxy


Edit haproxy configuration file and add the following contents to it

[root@dcpctredcont1 ~]# vi /etc/haproxy/haproxy.cfg


#---------------------------------------------------------------------

# Example configuration for a possible web application.  See the

# full configuration options online.

#

#   https://www.haproxy.org/download/1.8/doc/configuration.txt

#

#---------------------------------------------------------------------


#---------------------------------------------------------------------

# Global settings

#---------------------------------------------------------------------

global

    maxconn     20000

    log         /dev/log local0 info

    chroot      /var/lib/haproxy

    pidfile     /var/run/haproxy.pid

    user        haproxy

    group       haproxy

    daemon

    # turn on stats unix socket

    stats socket /var/lib/haproxy/stats

#---------------------------------------------------------------------

# common defaults that all the 'listen' and 'backend' sections will

# use if not designated in their block

#---------------------------------------------------------------------

defaults

    log                     global

    mode                    http

    option                  httplog

    option                  dontlognull

    option http-server-close

    option redispatch

    option forwardfor       except 127.0.0.0/8

    retries                 3

    maxconn                 20000

    timeout http-request    10000ms

    timeout http-keep-alive 10000ms

    timeout check           10000ms

    timeout connect         40000ms

    timeout client          300000ms

    timeout server          300000ms

    timeout queue           50000ms


# Enable HAProxy stats

listen stats

    bind :9000

    stats uri /stats

    stats refresh 10000ms


# Kube API Server

frontend k8s_api_frontend

    bind :6443

    default_backend k8s_api_backend

    mode tcp


backend k8s_api_backend

    mode tcp

    balance source

    server      dcpctredcont2 10.77.16.232:6443 check

    server      prsdlibskwrk8 10.64.119.17:6443 check

    server      prsdlibskwrk9 10.64.119.18:6443 check

    server      prsdlibskwrk10 10.64.119.19:6443 check


# OCP Machine Config Server

frontend ocp_machine_config_server_frontend

    mode tcp

    bind :22623

    default_backend ocp_machine_config_server_backend


backend ocp_machine_config_server_backend

    mode tcp

    balance source

    server      dcpctredcont2 10.77.16.232:22623 check

    server      prsdlibskwrk8 10.64.119.17:22623 check

    server      prsdlibskwrk9 10.64.119.18:22623 check

    server      prsdlibskwrk10 10.64.119.19:22623 check


# OCP Ingress - layer 4 tcp mode for each. Ingress Controller will handle layer 7.

frontend ocp_http_ingress_frontend

    bind :80

    default_backend ocp_http_ingress_backend

    mode tcp


backend ocp_http_ingress_backend

    balance source

    mode tcp

    server prsdlibskwrk8 10.64.119.17:80 check

    server prsdlibskwrk9 10.64.119.18:80 check

    server prsdlibskwrk10 10.64.119.19:80 check


frontend ocp_https_ingress_frontend

    bind *:443

    default_backend ocp_https_ingress_backend

    mode tcp


backend ocp_https_ingress_backend

    mode tcp

    balance source

    server prsdlibskwrk8 10.64.119.17:443 check

    server prsdlibskwrk9 10.64.119.18:443 check

    server prsdlibskwrk10 10.64.119.19:443 check


Set selinux rule to add an exception for haproxy.

[root@dcpctredcont1 ~]# setsebool -P haproxy_connect_any 1


Start and enable haproxy service

[root@dcpctredcont1 ~]# systemctl start haproxy

[root@dcpctredcont1 ~]# systemctl enable haproxy


Status of haproxy service

[root@dcpctredcont1 ~]# systemctl status haproxy
